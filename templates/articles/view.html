{% extends "base.html" %}

{% block title %}{{ article.title|title }}{% endblock %}

{% block description %}{{ article.description }}{% endblock %}

{% block css %}
<link href="{{ MEDIA_URL }}css/article-view.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<article>
    <header>
        <hgroup>
            <h1>{{ article.title|title }}</h1>
            <div id="article-author-date">
            {% if article.authors.all|length <= 2 %}
                <a href="mailto:{{ article.authors.all.0.email }}">{{ article.authors.all.0.get_full_name }}</a>
                {% if article.authors.all|length == 2 %}
                and <a href="mailto:{{ article.authors.all.1.email }}">{{ article.authors.all.1.get_full_name }}</a>
                {% endif %}
            {% else %}
            {% for author in article.authors.all %}
                {% if not forloop.last %}
                <a href="mailto:{{ author.email }}">{{ author.get_full_name }}</a>, 
                {% else %}
                and <a href="mailto:{{ author.email }}">{{ author.get_full_name }}</a>
                {% endif %}
            {% endfor %}
            {% endif %}
                <br />
                <time datetime="{{ article.date_created|date:"Y-m-d" }}" pubdate>{{ article.date_created|date:"F j, Y" }}</time>
                {% ifnotequal article.date_created article.date_updated %}
                    <br />Updated <time datetime="{{ article.date_updated|date:"Y-m-d" }}">{{ article.date_updated|date:"F j, Y" }}</time>
                {% endifnotequal %}
            </div>
            <h2>
                {{ article.description }}
            </h2>
        </hgroup>
    </header>
    {{ article.content|safe }}
</article>
<section id="comments">
    <h1>Comments</h1>
    {% if flash.comment_response %}
        <p>{{ flash.comment_response }}</p>
    {% endif %}

    {% load osl_comments_lib %}

    {% is_edit_form_present as edit_form_present %}
    {% is_reply_form_present as reply_form_present %}
    {% if not edit_form_present and not reply_form_present %}
        {% render_anon_comment_form for article %}
    {% endif %}

    {% get_threaded_comment_list for article as comments sorted by newest %}
    {% if not comments %}
    <p>There do not appear to be any comments for this article.</p>
    {% else %}
    <ul id="comment-list">
        {% if not comments.0.parent %}
            <li class="comment-pagination-parent">
                <div class="comment-header">
                    {% if comments.0.parent_comment_user_url %}
                    <a href="{{ comments.0.parent_comment_user_url }}">{{ comments.0.parent_comment_user_name }}</a>
                    {% else %}
                        {{ comments.0.parent_comment_user_name }}
                    {% endif %}
                    said {{ comments.0.thread_submit_date|timesince }} ago:
                    {% if comments.0.parent_comment_edit_timestamp != comments.0.thread_submit_date %}
                        *edited
                    {% endif %}
                </div>
                <blockquote class="comment-body">
                    {{ comments.0.parent_comment_comment }}
                </blockquote>
                <ul class="comment-links">
                    <li><a href="#">Report this comment</a></li>
                </ul>
            </li>
        {% endif %}
        {% for comment in comments %}
        <li{% if not comment.parent %} class="comment-child"{% endif %}>
            <div class="comment-header">
                {% if comment.url %}
                    <a href="{{ comment.url }}">{{ comment.name }}</a>
                {% else %}
                    {{ comment.name }}
                {% endif %}
                said {{ comment.submit_date|timesince }} ago:
                {% if comment.edit_timestamp != comment.submit_date %}
                    *edited
                {% endif %}
            </div>
            {% should_display_edit_form for comment as display_edit_form %}
            {% if display_edit_form %}
                {% render_edit_comment_form for comment %}
            {% else %}
                <blockquote class="comment-body">
                    {{ comment.comment }}
                </blockquote>
                <ul class="comment-links">
                    {% if comment.parent %}
                        <li><a href="{% output_comment_reply_url for comment %}">Reply</a></li>
                    {% endif %}
                    {% if comment.user == request.user %}
                        <li><a href="{% output_comment_edit_url for comment %}">Edit</a></li>
                    {% endif %}
                    {% if comment.user != request.user %}
                        <li><a href="#">Report this comment</a></li>
                    {% endif %}
                </ul>
            {% endif %}
        </li>
        {% should_display_reply_form for comment as display_reply_form %}
        {% if display_reply_form %}
            <li class="comment-child">{% render_anon_comment_form for article replying to comment %}</li>
        {% endif %}
        {% endfor %}
    </ul>
    {% get_comment_paginator_page for article as comment_page %}
    {% if comment_page.has_previous %}
        <a href="{% output_previous_comment_page_url with comment_page %}">Previous</a>
    {% endif %}
    Page {{ comment_page.number }} of {{ comment_page.paginator.num_pages }}
    {% if comment_page.has_next %}
        <a href="{% output_next_comment_page_url with comment_page %}">Next</a>
    {% endif %}
    {% endif %}
</section>
{% endblock %}
